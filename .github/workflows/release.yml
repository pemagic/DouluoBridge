name: Cross-Platform Release

on:
  push:
    tags:
      - 'v*' # Push events to matching v*, i.e. v1.0, v20.15.10

jobs:
  build_ios:
    name: Build iOS App
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build and Archive
        run: |
          cd ios
          xcodebuild clean archive -project DouluoBridge.xcodeproj -scheme DouluoBridge -configuration Release -archivePath "build/DouluoBridge.xcarchive" CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
          
      - name: Generate Export Options
        run: |
          cd ios
          cat << 'EOF' > ExportOptions.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>compileBitcode</key>
              <false/>
              <key>method</key>
              <string>development</string>
          </dict>
          </plist>
          EOF

      - name: Export IPA
        run: |
          cd ios
          xcodebuild -exportArchive -archivePath build/DouluoBridge.xcarchive -exportPath build -exportOptionsPlist ExportOptions.plist CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO || echo "IPA Export Failed (expected without certs in CI, will upload archive instead)"
          
      - name: Upload iOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: ios/build/DouluoBridge.xcarchive

  build_android:
    name: Build Android App
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Make gradlew executable
        run: |
          cd android
          chmod +x gradlew
          
      - name: Build APK
        run: |
          cd android
          ./gradlew assembleRelease > build.log 2>&1 || (git config --global user.name 'github-actions[bot]' && git config --global user.email 'github-actions[bot]@users.noreply.github.com' && git switch -c ci-failure && mv build.log error.log && git add error.log && git commit -m "Upload error log" && git push -f origin ci-failure && exit 1)

      - name: Upload Android Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: android/app/build/outputs/apk/release/app-release-unsigned.apk

  release:
    name: Publish Release
    needs: [build_ios, build_android]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download iOS Build
        uses: actions/download-artifact@v4
        with:
          name: ios-build
          path: drop/ios

      - name: Download Android Build
        uses: actions/download-artifact@v4
        with:
          name: android-build
          path: drop/android
          
      - name: Rename Artifacts
        run: |
          mv drop/android/app-release-unsigned.apk DouluoBridge-Android-${{ github.ref_name }}.apk
          cd drop/ios && zip -r ../../DouluoBridge-iOS-${{ github.ref_name }}.xcarchive.zip .
          
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            DouluoBridge-Android-${{ github.ref_name }}.apk
            DouluoBridge-iOS-${{ github.ref_name }}.xcarchive.zip
          generate_release_notes: true
